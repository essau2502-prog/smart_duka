<!DOCTYPE html>
<html lang="sw">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Duka Pro - Profit & Stock</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#2c3e50">
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f0f2f5; margin: 0; padding-bottom: 60px; }
        .header { background: #2c3e50; color: white; padding: 15px; text-align: center; }
        .main-card { background: white; margin: 10px; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .total-box { background: #27ae60; color: white; padding: 20px; border-radius: 8px; margin: 10px; text-align: center; }
        input, select { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box; }
        button { cursor: pointer; border: none; border-radius: 5px; font-weight: bold; padding: 12px; margin-top: 5px; width: 100%; }
        .btn-primary { background: #2c3e50; color: white; }
        .btn-uza { background: #27ae60; color: white; }
        .item-row { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #eee; font-size: 0.85rem; }
        .tab-bar { display: flex; overflow-x: auto; padding: 10px; gap: 5px; background: #fff; border-bottom: 1px solid #ddd; position: sticky; top: 0; z-index: 100; }
        .tab-btn { padding: 10px 15px; background: #bdc3c7; border-radius: 5px; white-space: nowrap; flex-shrink: 0; }
        .active-tab { background: #2c3e50; color: white; }
        .hidden { display: none !important; }
        .profit-text { color: #27ae60; font-weight: bold; font-size: 0.8rem; }
        .auth-page { position: fixed; width: 100%; height: 100%; background: white; z-index: 2000; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        #previewImg { width: 100%; max-height: 200px; object-fit: contain; margin-top: 10px; border-radius: 5px; display: none; }
    </style>
</head>
<body>

    <div id="authPage" class="auth-page">
        <h2>SMART DUKA PRO üè™</h2>
        <div id="loginForm">
            <input type="text" id="loginDukaID" placeholder="ID ya Duka">
            <input type="text" id="loginUser" placeholder="Jina (admin/muuzaji)">
            <input type="password" id="loginPass" placeholder="Neno la Siri">
            <button onclick="handleLogin()" class="btn-primary">INGIA KAZINI</button>
            <p onclick="toggleAuth()" style="color: #3498db; cursor: pointer; margin-top: 15px;">Sajili Duka Jipya</p>
        </div>
        <div id="registerForm" class="hidden">
            <input type="text" id="regDukaName" placeholder="Jina la Duka">
            <input type="text" id="regDukaID" placeholder="ID ya Duka">
            <input type="password" id="regPass" placeholder="Siri ya Admin">
            <button onclick="handleRegister()" class="btn-primary" style="background: #27ae60;">SAJILI DUKA</button>
        </div>
    </div>

    <div id="mainApp" class="hidden">
        <div class="header">
            <h2 id="displayDukaName">DUKA LAKO</h2>
            <div style="font-size: 0.8rem;">Mtumiaji: <span id="displayUser"></span></div>
        </div>

        <div id="statusBox" class="total-box">
            <div id="statusText">MZIGO LEO</div>
            <div style="font-size: 1.8rem; font-weight: bold;">Tsh <span id="leoTotal">0</span></div>
            <div id="profitDisplay" style="font-size: 0.9rem; opacity: 0.9;">Faida ya Leo: Tsh 0</div>
        </div>

        <div class="tab-bar">
            <button id="tabMauzoBtn" class="tab-btn active-tab" onclick="switchTab('mauzo')">Uza</button>
            <button id="tabStockBtn" class="tab-btn" onclick="switchTab('stock')">Mzigo Mpya üì¶</button>
            <button id="tabHistoryBtn" class="tab-btn" onclick="switchTab('history')">Ripoti üìä</button>
            <button id="tabMadeniBtn" class="tab-btn" onclick="switchTab('madeni')">Madeni</button>
        </div>

        <div id="tabMauzo">
            <div class="main-card">
                <h3>Fanya Mauzo</h3>
                <select id="selBidhaa" onchange="updatePreselPrice()">
                    <option value="">Chagua Bidhaa...</option>
                </select>
                <input type="number" id="uzaBei" placeholder="Bei ya Kuuzia">
                <input type="number" id="uzaIdadi" placeholder="Idadi" value="1">
                <button onclick="ongezaMauzo()" class="btn-uza">KAMILISHA MAUZO</button>
            </div>
            <div class="main-card">
                <h3>Mauzo ya Leo</h3>
                <div id="orodhaMauzo">Inapakia...</div>
            </div>
        </div>

        <div id="tabStock" class="hidden">
            <div class="main-card">
                <h3>Sajili Mzigo Mpya</h3>
                <input type="text" id="stkBidhaa" placeholder="Jina la Bidhaa">
                <input type="number" id="stkBeiB" placeholder="Bei ya Kununulia (Moja)">
                <input type="number" id="stkBeiS" placeholder="Bei ya Kuuzia (Moja)">
                <input type="number" id="stkIdadi" placeholder="Idadi/Stok">
                
                <p style="font-size: 0.8rem; color: #666;">Piga picha ya Bidhaa/Risiti (M-Pesa):</p>
                <input type="file" id="stkFile" accept="image/*" capture="environment" onchange="previewImage(this)">
                <img id="previewImg">
                
                <button onclick="hifadhiMzigo()" class="btn-primary" style="background:#e67e22;">HIFADHI MZIGO</button>
            </div>
            <div class="main-card">
                <h3>Stok iliyopo</h3>
                <div id="orodhaStock"></div>
            </div>
        </div>

        <div id="tabHistory" class="hidden">
            <div class="main-card">
                <h3>Ripoti ya Faida (Mwezi)</h3>
                <input type="month" id="reportMonth">
                <button onclick="pataRipotiYaMwezi()" class="btn-primary">Tazama Ripoti</button>
                <div id="monthSummary"></div>
            </div>
        </div>

        <div id="tabMadeni" class="hidden">
            <div class="main-card">
                <input type="text" id="mdeni_jina" placeholder="Mteja">
                <input type="number" id="mdeni_kiasi" placeholder="Kiasi">
                <button onclick="sajiliDeni()" style="background:#8e44ad; color:white;">HIFADHI DENI</button>
            </div>
            <div id="orodhaMadeni" class="main-card"></div>
        </div>

        <button onclick="location.reload()" style="margin:20px auto; display:block; border:none; color:gray;">Log Out</button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, where, doc, setDoc, getDoc, updateDoc, deleteDoc, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDXG65JsQ2pB96O33T5itgWUNJPH8IzFuk",
            authDomain: "smart-duka-1931e.firebaseapp.com",
            projectId: "smart-duka-1931e",
            storageBucket: "smart-duka-1931e.firebasestorage.app",
            messagingSenderId: "768053863535",
            appId: "1:768053863535:web:6fb7d999e9adf71ba4d99a"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let currentDukaID = null;
        let currentUser = null;
        let isAdmin = false;
        let leoDate = new Date().toLocaleDateString('en-GB');
        let dukaStock = {}; // Local copy for profit calc

        // PREVIEW IMAGE
        window.previewImage = (input) => {
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = document.getElementById('previewImg');
                img.src = e.target.result;
                img.style.display = 'block';
            };
            if(input.files[0]) reader.readAsDataURL(input.files[0]);
        };

        window.toggleAuth = () => {
            document.getElementById('loginForm').classList.toggle('hidden');
            document.getElementById('registerForm').classList.toggle('hidden');
        };

        window.handleLogin = async () => {
            const dukaID = document.getElementById('loginDukaID').value.toLowerCase().trim();
            const user = document.getElementById('loginUser').value.toLowerCase().trim();
            const pass = document.getElementById('loginPass').value;
            const snap = await getDoc(doc(db, "maduka", dukaID));
            if (snap.exists() && snap.data().status === 'active') {
                const data = snap.data();
                if (user === 'admin' && pass === data.adminPass) {
                    isAdmin = true;
                    completeLogin(dukaID, data.name, 'Admin');
                } else {
                    const sSnap = await getDoc(doc(db, "maduka", dukaID, "staff", user));
                    if (sSnap.exists() && sSnap.data().pass === pass) {
                        isAdmin = false;
                        completeLogin(dukaID, data.name, user);
                    } else { alert("Siri imekosewa!"); }
                }
            } else { alert("Duka halipo!"); }
        };

        function completeLogin(id, name, user) {
            currentDukaID = id; currentUser = user;
            document.getElementById('authPage').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            document.getElementById('displayDukaName').innerText = name;
            document.getElementById('displayUser').innerText = user.toUpperCase();
            anzishaLogic();
        }

        function anzishaLogic() {
            // Watch Stock
            onSnapshot(collection(db, "maduka", currentDukaID, "stok"), (snap) => {
                let options = '<option value="">Chagua Bidhaa...</option>';
                let list = '';
                snap.forEach(d => {
                    const s = d.data();
                    dukaStock[d.id] = s;
                    options += `<option value="${d.id}">${s.bidhaa} (Inabaki: ${s.idadi})</option>`;
                    list += `<div class="item-row"><span>${s.bidhaa}<br><small>Bei B: ${s.beiB} | S: ${s.beiS}</small></span><span>${s.idadi}</span></div>`;
                });
                document.getElementById('selBidhaa').innerHTML = options;
                document.getElementById('orodhaStock').innerHTML = list;
            });

            // Watch Mauzo Leo & Calc Profit
            onSnapshot(query(collection(db, "mauzo"), where("dukaID", "==", currentDukaID), where("tarehe", "==", leoDate)), (snap) => {
                let h = ''; let totalSales = 0; let totalProfit = 0;
                snap.forEach(d => {
                    const m = d.data();
                    totalSales += m.jumla;
                    totalProfit += (m.profit || 0);
                    h += `<div class="item-row"><span>${m.bidhaa} (x${m.idadi})</span><span>${m.jumla.toLocaleString()}</span></div>`;
                });
                document.getElementById('orodhaMauzo').innerHTML = h || 'Hakuna mauzo.';
                document.getElementById('leoTotal').innerText = totalSales.toLocaleString();
                document.getElementById('profitDisplay').innerText = `Faida ya Leo: Tsh ${totalProfit.toLocaleString()}`;
            });
        }

        window.updatePreselPrice = () => {
            const bidhaaId = document.getElementById('selBidhaa').value;
            if(bidhaaId && dukaStock[bidhaaId]) {
                document.getElementById('uzaBei').value = dukaStock[bidhaaId].beiS;
            }
        };

        window.hifadhiMzigo = async () => {
            const bidhaa = document.getElementById('stkBidhaa').value;
            const beiB = Number(document.getElementById('stkBeiB').value);
            const beiS = Number(document.getElementById('stkBeiS').value);
            const idadi = Number(document.getElementById('stkIdadi').value);
            
            if(bidhaa && beiB && beiS) {
                // Tunatumia jina la bidhaa kama ID kwa urahisi
                const bidhaaID = bidhaa.toLowerCase().replace(/\s/g, '_');
                await setDoc(doc(db, "maduka", currentDukaID, "stok", bidhaaID), {
                    bidhaa, beiB, beiS, idadi, muuzaji: currentUser
                });
                alert("Mzigo umehifadhiwa!");
                document.getElementById('stkBidhaa').value = '';
                document.getElementById('previewImg').style.display = 'none';
            }
        };

        window.ongezaMauzo = async () => {
            const bId = document.getElementById('selBidhaa').value;
            const uzaBei = Number(document.getElementById('uzaBei').value);
            const uzaIdadi = Number(document.getElementById('uzaIdadi').value);
            
            if(bId && uzaBei) {
                const item = dukaStock[bId];
                const profitPerItem = uzaBei - item.beiB;
                const totalProfit = profitPerItem * uzaIdadi;
                
                // 1. Save Sale
                await addDoc(collection(db, "mauzo"), {
                    bidhaa: item.bidhaa, idadi: uzaIdadi, bei: uzaBei, jumla: uzaBei * uzaIdadi,
                    profit: totalProfit, dukaID: currentDukaID, tarehe: leoDate, muuzaji: currentUser
                });
                
                // 2. Update Stock (Punguza idadi)
                await updateDoc(doc(db, "maduka", currentDukaID, "stok", bId), {
                    idadi: item.idadi - uzaIdadi
                });
                
                document.getElementById('uzaIdadi').value = 1;
            }
        };

        window.pataRipotiYaMwezi = async () => {
            const mYear = document.getElementById('reportMonth').value;
            if(!mYear) return;
            const [y, m] = mYear.split('-');
            const snap = await getDocs(query(collection(db, "mauzo"), where("dukaID", "==", currentDukaID)));
            let tS = 0; let tP = 0;
            snap.forEach(d => {
                const data = d.data();
                const [day, mon, year] = data.tarehe.split('/');
                if(mon === m && year === y) { tS += data.jumla; tP += (data.profit || 0); }
            });
            document.getElementById('monthSummary').innerHTML = `
                <div style="background:#2c3e50; color:white; padding:15px; border-radius:8px; margin-top:10px;">
                    Mauzo: Tsh ${tS.toLocaleString()}<br>
                    <span style="color:#27ae60; font-size:1.2rem;">FAIDA: Tsh ${tP.toLocaleString()}</span>
                </div>`;
        };

        window.switchTab = (t) => {
            ['mauzo','stock','history','madeni'].forEach(id => {
                document.getElementById('tab' + id.charAt(0).toUpperCase() + id.slice(1)).classList.toggle('hidden', t !== id);
                document.getElementById('tab' + id.charAt(0).toUpperCase() + id.slice(1) + 'Btn').classList.toggle('active-tab', t === id);
            });
        };
    </script>
</body>
</html>
