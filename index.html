<!DOCTYPE html>
<html lang="sw">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Duka Pro v7.9</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f0f2f5; margin: 0; padding-bottom: 60px; }
        .header { background: #2c3e50; color: white; padding: 15px; text-align: center; position: sticky; top: 0; z-index: 100; }
        .main-card { background: white; margin: 10px; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .total-box { background: #27ae60; color: white; padding: 20px; border-radius: 8px; margin: 10px; text-align: center; }
        input, select { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box; font-size: 1rem; }
        button { cursor: pointer; border: none; border-radius: 5px; font-weight: bold; padding: 12px; margin-top: 5px; width: 100%; transition: 0.3s; }
        .btn-primary { background: #2c3e50; color: white; }
        .btn-uza { background: #27ae60; color: white; }
        .btn-kopa { background: #e67e22; color: white; }
        .item-row { display: flex; justify-content: space-between; align-items: center; padding: 12px; border-bottom: 1px solid #eee; }
        .tab-bar { display: flex; overflow-x: auto; padding: 10px; gap: 5px; background: #fff; border-bottom: 1px solid #ddd; }
        .tab-btn { padding: 10px 15px; background: #bdc3c7; border-radius: 5px; white-space: nowrap; flex-shrink: 0; }
        .active-tab { background: #2c3e50; color: white; }
        .hidden { display: none !important; }
        .auth-page { position: fixed; width: 100%; height: 100%; background: white; z-index: 2000; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 20px; box-sizing: border-box; }
        .support-box { background: #ecf0f1; padding: 15px; border-radius: 8px; text-align: center; border: 2px dashed #2c3e50; margin-top: 10px; }
        .whatsapp-btn { background: #25D366; color: white; padding: 12px; display: block; text-decoration: none; border-radius: 50px; margin-top: 10px; font-weight: bold; }
        .web-btn { background: #3498db; color: white; padding: 12px; display: block; text-decoration: none; border-radius: 50px; margin-top: 10px; font-weight: bold; }
    </style>
</head>
<body>

    <div id="authPage" class="auth-page">
        <h2>SMART DUKA PRO üè™</h2>
        
        <div id="loginForm">
            <input type="text" id="loginDukaID" placeholder="ID ya Duka">
            <input type="text" id="loginUser" placeholder="Jina (admin/staff)">
            <input type="password" id="loginPass" placeholder="Neno la Siri">
            <button onclick="handleLogin()" class="btn-primary">INGIA KAZINI</button>
            <p onclick="toggleAuth()" style="color: #3498db; cursor: pointer; margin-top: 15px;">Sajili Duka Jipya</p>
        </div>

        <div id="registerForm" class="hidden">
            <input type="text" id="regDukaName" placeholder="Jina la Duka">
            <input type="text" id="regDukaID" placeholder="Tengeneza ID ya Duka">
            <input type="password" id="regPass" placeholder="Siri ya Admin">
            <button onclick="handleRegister()" class="btn-primary" style="background: #27ae60;">SAJILI DUKA</button>
            <p onclick="toggleAuth()" style="color: #3498db; cursor: pointer; margin-top: 15px;">Rudi kwenye Login</p>
        </div>
    </div>

    <div id="mainApp" class="hidden">
        <div class="header">
            <h2 id="displayDukaName">DUKA LAKO</h2>
            <span id="displayUser" style="font-size: 0.8rem; background: #f1c40f; color: #000; padding: 2px 10px; border-radius: 10px;"></span>
        </div>

        <div id="statusBox" class="total-box">
            <div>Mauzo ya Leo</div>
            <div style="font-size: 1.8rem; font-weight: bold;">Tsh <span id="leoTotal">0</span></div>
            <div id="profitDisplay" style="font-size: 0.9rem; opacity: 0.9;">Faida Leo: Tsh 0</div>
        </div>

        <div class="tab-bar">
            <button id="tabMauzoBtn" class="tab-btn active-tab" onclick="switchTab('mauzo')">Mauzo</button>
            <button id="tabStockBtn" class="tab-btn" onclick="switchTab('stock')">Stok</button>
            <button id="tabMadeniBtn" class="tab-btn" onclick="switchTab('madeni')">Madeni</button>
            <button id="tabStaffBtn" class="tab-btn" onclick="switchTab('staff')">Wafanyakazi</button>
            <button id="tabSupportBtn" class="tab-btn" onclick="switchTab('support')">Msaada</button>
        </div>

        <div id="tabMauzo" class="main-card">
            <h4>Fanya Mauzo</h4>
            <input list="bidhaaList" id="uzaBidhaaName" placeholder="Andika jina la bidhaa..." onchange="autoFillPrice()">
            <datalist id="bidhaaList"></datalist>
            <input type="number" id="uzaBei" placeholder="Bei ya Kuuzia">
            <input type="number" id="uzaIdadi" placeholder="Idadi" value="1">
            <button onclick="fanyaMauzo()" class="btn-uza">KAMILISHA MAUZO</button>
            <hr>
            <h4>Mauzo ya Leo</h4>
            <div id="orodhaMauzo"></div>
        </div>

        <div id="tabStock" class="hidden main-card">
            <div id="adminStockSection" class="hidden">
                <h4>Ingiza Mzigo</h4>
                <input type="text" id="pName" placeholder="Jina la Bidhaa">
                <input type="number" id="pBuy" placeholder="Bei ya Kununua">
                <input type="number" id="pSell" placeholder="Bei ya Kuuza">
                <input type="number" id="pQty" placeholder="Idadi">
                <button onclick="ongezaStock()" class="btn-primary">HIFADHI KWENYE STOK</button>
                <hr>
            </div>
            <h4>Hali ya Stok</h4>
            <div id="orodhaStock"></div>
        </div>

        <div id="tabMadeni" class="hidden main-card">
            <h4>Sajili Deni Jipya</h4>
            <input type="text" id="mdeni_jina" placeholder="Jina la Mdeni">
            <input type="text" id="mdeni_bidhaa" placeholder="Bidhaa aliyochukua">
            <input type="number" id="mdeni_kiasi" placeholder="Kiasi anachodaiwa">
            <button onclick="sajiliDeni()" class="btn-kopa">HIFADHI DENI</button>
            <hr>
            <h4>Orodha ya Madeni</h4>
            <div id="orodhaMadeni"></div>
        </div>

        <div id="tabStaff" class="hidden main-card">
            <div id="adminStaffSection" class="hidden">
                <h4>Ongeza Mfanyakazi</h4>
                <input type="text" id="staffName" placeholder="Jina la Mfanyakazi">
                <input type="password" id="staffPass" placeholder="Siri yake">
                <button onclick="ongezaStaff()" class="btn-primary">SAJILI STAFF</button>
                <hr>
            </div>
            <h4>Orodha ya Staff</h4>
            <div id="orodhaStaff"></div>
        </div>

        <div id="tabSupport" class="hidden main-card">
            <div class="support-box">
                <strong>ESSAU BRAND OFFICIAL</strong><br>
                <a href="https://essau2502-prog.github.io/smart_duka/" target="_blank" class="web-btn">üåê TEMBELEA WEBSITE</a>
                <hr style="border: 0.5px solid #ccc; margin: 15px 0;">
                <p>Msaada wa Kiufundi:</p>
                <a href="https://wa.me/255747163749" class="whatsapp-btn">üí¨ CHAT WHATSAPP</a>
            </div>
            <br>
            <button onclick="location.reload()" style="background:#e74c3c; color:white;">LOG OUT</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, where, doc, getDoc, setDoc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDXG65JsQ2pB96O33T5itgWUNJPH8IzFuk",
            authDomain: "smart-duka-1931e.firebaseapp.com",
            projectId: "smart-duka-1931e",
            storageBucket: "smart-duka-1931e.firebasestorage.app",
            messagingSenderId: "768053863535",
            appId: "1:768053863535:web:6fb7d999e9adf71ba4d99a"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        let currentDukaID = null, isAdmin = false, currentUser = "", leo = new Date().toLocaleDateString('en-GB'), dukaStock = {};

        window.toggleAuth = () => {
            document.getElementById('loginForm').classList.toggle('hidden');
            document.getElementById('registerForm').classList.toggle('hidden');
        };

        window.handleRegister = async () => {
            const name = document.getElementById('regDukaName').value;
            const id = document.getElementById('regDukaID').value.toLowerCase().trim();
            const pass = document.getElementById('regPass').value;
            if(name && id && pass) {
                await setDoc(doc(db, "maduka", id), { name, adminPass: pass });
                alert("Duka Limesajiliwa! Sasa Ingia."); toggleAuth();
            }
        };

        window.handleLogin = async () => {
            const dukaID = document.getElementById('loginDukaID').value.toLowerCase().trim();
            const user = document.getElementById('loginUser').value.toLowerCase().trim();
            const pass = document.getElementById('loginPass').value;
            
            const dukaSnap = await getDoc(doc(db, "maduka", dukaID));
            if (!dukaSnap.exists()) { alert("ID ya Duka haipo!"); return; }

            if (user === 'admin' && pass === dukaSnap.data().adminPass) {
                isAdmin = true; currentUser = "Admin"; loginSuccess(dukaID, dukaSnap.data().name);
            } else {
                const staffSnap = await getDoc(doc(db, "maduka", dukaID, "staff", user));
                if (staffSnap.exists() && staffSnap.data().siri === pass) {
                    isAdmin = false; currentUser = user; loginSuccess(dukaID, dukaSnap.data().name);
                } else { alert("Login Imefeli!"); }
            }
        };

        function loginSuccess(id, dukaName) {
            currentDukaID = id;
            document.getElementById('authPage').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            document.getElementById('displayDukaName').innerText = dukaName;
            document.getElementById('displayUser').innerText = currentUser;
            if(isAdmin) {
                document.getElementById('adminStockSection').classList.remove('hidden');
                document.getElementById('adminStaffSection').classList.remove('hidden');
            }
            anzaLogic();
        }

        function anzaLogic() {
            onSnapshot(collection(db, "maduka", currentDukaID, "stok"), (snap) => {
                let h = "", opts = "";
                snap.forEach(doc => {
                    const d = doc.data(); dukaStock[doc.id] = d;
                    h += `<div class="item-row"><span>${d.bidhaa}</span><b>${d.idadi} baki</b></div>`;
                    opts += `<option value="${d.bidhaa}">`;
                });
                document.getElementById('orodhaStock').innerHTML = h;
                document.getElementById('bidhaaList').innerHTML = opts;
            });

            onSnapshot(query(collection(db, "mauzo"), where("dukaID", "==", currentDukaID), where("tarehe", "==", leo)), (snap) => {
                let h = "", total = 0, profit = 0;
                snap.forEach(doc => {
                    const d = doc.data(); total += d.jumla; profit += d.profit;
                    h += `<div class="item-row"><span>${d.bidhaa} (x${d.idadi})</span><b>${d.jumla.toLocaleString()}</b></div>`;
                });
                document.getElementById('orodhaMauzo').innerHTML = h;
                document.getElementById('leoTotal').innerText = total.toLocaleString();
                if(isAdmin) document.getElementById('profitDisplay').innerText = "Faida Leo: Tsh " + profit.toLocaleString();
            });

            onSnapshot(collection(db, "maduka", currentDukaID, "staff"), (snap) => {
                let h = "";
                snap.forEach(d => { h += `<div class="item-row"><span>${d.id}</span>${isAdmin ? `<button onclick="futaStaff('${d.id}')" style="width:auto; background:red; color:white; padding:5px;">Futa</button>` : ''}</div>`; });
                document.getElementById('orodhaStaff').innerHTML = h;
            });

            onSnapshot(query(collection(db, "madeni"), where("dukaID", "==", currentDukaID)), (snap) => {
                let h = ""; snap.forEach(doc => {
                    const d = doc.data(); h += `<div class="item-row" style="color:#e67e22;"><span>${d.customer}: ${d.bidhaa}</span><b>${d.total.toLocaleString()}</b></div>`;
                });
                document.getElementById('orodhaMadeni').innerHTML = h;
            });
        }

        window.autoFillPrice = () => {
            const jina = document.getElementById('uzaBidhaaName').value;
            for (let id in dukaStock) { if (dukaStock[id].bidhaa === jina) { document.getElementById('uzaBei').value = dukaStock[id].beiS; break; } }
        };

        window.fanyaMauzo = async () => {
            const jina = document.getElementById('uzaBidhaaName').value, bei = Number(document.getElementById('uzaBei').value), qty = Number(document.getElementById('uzaIdadi').value);
            if(!jina || bei <= 0) return;
            let beiB = 0, bID = null;
            for (let id in dukaStock) { if (dukaStock[id].bidhaa.toLowerCase() === jina.toLowerCase()) { beiB = dukaStock[id].beiB; bID = id; break; } }
            const total = bei * qty, profit = (bei - beiB) * qty;
            await addDoc(collection(db, "mauzo"), { bidhaa: jina, idadi: qty, jumla: total, profit, dukaID: currentDukaID, tarehe: leo, muuzaji: currentUser });
            if (bID) { await updateDoc(doc(db, "maduka", currentDukaID, "stok", bID), { idadi: dukaStock[bID].idadi - qty }); }
            alert("Uuzaji Umekamilika!");
            document.getElementById('uzaBidhaaName').value = ""; document.getElementById('uzaBei').value = "";
        }

        window.sajiliDeni = async () => {
            const j = document.getElementById('mdeni_jina').value, b = document.getElementById('mdeni_bidhaa').value, k = Number(document.getElementById('mdeni_kiasi').value);
            if(j && k) {
                await addDoc(collection(db, "madeni"), { customer: j, bidhaa: b, total: k, dukaID: currentDukaID, tarehe: leo });
                alert("Deni Limehifadhiwa!");
                document.getElementById('mdeni_jina').value = ""; document.getElementById('mdeni_kiasi').value = "";
            }
        };

        window.ongezaStaff = async () => {
            const n = document.getElementById('staffName').value.toLowerCase().trim(), s = document.getElementById('staffPass').value;
            if(n && s) { await setDoc(doc(db, "maduka", currentDukaID, "staff", n), { siri: s }); alert("Staff ameongezwa!"); }
        };

        window.futaStaff = async (id) => { if(confirm("Futa huyu staff?")) await deleteDoc(doc(db, "maduka", currentDukaID, "staff", id)); };

        window.ongezaStock = async () => {
            const b = document.getElementById('pName').value, bB = Number(document.getElementById('pBuy').value), bS = Number(document.getElementById('pSell').value), q = Number(document.getElementById('pQty').value);
            if(b && bB) {
                const id = b.toLowerCase().replace(/\s/g, '_');
                await setDoc(doc(db, "maduka", currentDukaID, "stok", id), { bidhaa: b, beiB: bB, beiS: bS, idadi: q });
                alert("Mzigo umehifadhiwa!");
            }
        };

        window.switchTab = (t) => {
            ['mauzo','stock','madeni','staff','support'].forEach(id => {
                const card = document.getElementById('tab' + id.charAt(0).toUpperCase() + id.slice(1));
                const btn = document.getElementById('tab' + id.charAt(0).toUpperCase() + id.slice(1) + 'Btn');
                if(card) card.classList.toggle('hidden', t !== id);
                if(btn) btn.classList.toggle('active-tab', t === id);
            });
        };
    </script>
</body>
</html>
