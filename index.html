<!DOCTYPE html>
<html lang="sw">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Duka Live - Pro</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f0f2f5; margin: 0; padding-bottom: 50px; }
        #loginPage { position: fixed; width: 100%; height: 100%; background: white; z-index: 2000; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .header { background: #2c3e50; color: white; padding: 20px; text-align: center; }
        .main-card { background: white; margin: 10px; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .total-box { background: #27ae60; color: white; padding: 20px; border-radius: 8px; margin: 10px; text-align: center; transition: 0.3s; }
        input { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box; }
        button { cursor: pointer; border: none; border-radius: 5px; font-weight: bold; width: 100%; padding: 12px; margin-top: 5px; }
        .btn-uza { background: #27ae60; color: white; width: 100%; }
        .btn-funga { background: #e67e22; color: white; width: 100%; }
        .btn-fungua { background: #2c3e50; color: white; width: 100%; }
        .btn-deni { background: #8e44ad; color: white; width: 100%; }
        .btn-futa { background: #ff4d4d; color: white; padding: 5px 8px; font-size: 0.7rem; width: auto; }
        .item-row { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #eee; }
        .badge { font-size: 0.8rem; background: rgba(255,255,255,0.2); padding: 2px 10px; border-radius: 10px; }
        .tab-btn { padding: 10px; width: 48%; background: #bdc3c7; color: black; }
        .active-tab { background: #2c3e50; color: white; }
    </style>
</head>
<body>

    <div id="loginPage">
        <h2>SMART DUKA LIVE üè™</h2>
        <input type="text" id="username" style="width: 80%;" placeholder="Jina la mtumiaji">
        <input type="password" id="password" style="width: 80%;" placeholder="Neno la siri">
        <button onclick="checkLogin()" style="width: 85%; background: #2c3e50; color: white;">INGIA</button>
        <p id="errorMsg" style="color: red;"></p>
    </div>

    <div id="mainApp" style="display: none;">
        <div class="header">
            <h2 id="dukaName">SMART DUKA üè™</h2>
            <div id="userBadge" class="badge"></div>
        </div>

        <div id="statusBox" class="total-box">
            <div id="statusText" style="font-weight: bold;">Inapakia...</div>
            <div style="font-size: 2.2rem; font-weight: bold;">Tsh <span id="leoTotal">0</span></div>
            <small id="tareheLeo"></small>
        </div>

        <div style="padding: 10px; display: flex; justify-content: space-between;">
            <button id="tabMauzoBtn" class="tab-btn active-tab" onclick="switchTab('mauzo')">Mauzo</button>
            <button id="tabMadeniBtn" class="tab-btn" onclick="switchTab('madeni')">Madeni üìù</button>
        </div>

        <div id="tabMauzo">
            <div class="main-card" id="cardFungua" style="display: none; text-align: center;">
                <p>Biashara imefungwa kwa sasa.</p>
                <button onclick="badiliHaliDuka('Wazi')" class="btn-fungua">FUNGUA BIASHARA YA LEO</button>
            </div>

            <div id="sectionMauzoInput" class="main-card" style="display: none;">
                <h3>Sajili Mauzo</h3>
                <input type="text" id="bidhaa" placeholder="Jina la bidhaa">
                <input type="number" id="bei" placeholder="Bei ya kitu kimoja">
                <input type="number" id="idadi" placeholder="Idadi" value="1">
                <button onclick="ongezaMauzo()" class="btn-uza">UZA SASA</button>
            </div>

            <div class="main-card">
                <h3>Orodha ya Mauzo ya Leo</h3>
                <div id="orodhaMauzo">Inapakia mauzo...</div>
                <button id="btnFungaDuka" onclick="badiliHaliDuka('Imefungwa')" class="btn-funga" style="display:none; margin-top:20px;">FUNGA BIASHARA (Z-REPORT)</button>
            </div>
        </div>

        <div id="tabMadeni" style="display: none;">
            <div class="main-card">
                <h3>Daftari la Madeni</h3>
                <input type="text" id="mdeni_jina" placeholder="Jina la aliyekopa">
                <input type="number" id="mdeni_kiasi" placeholder="Kiasi anachodaiwa">
                <button onclick="sajiliDeni()" class="btn-deni">HIFADHI DENI</button>
            </div>
            <div class="main-card">
                <h3>Madeni Yanayodaiwa</h3>
                <div id="orodhaMadeni">Inapakia madeni...</div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, where, doc, setDoc, deleteDoc, updateDoc, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDXG65JsQ2pB96O33T5itgWUNJPH8IzFuk",
            authDomain: "smart-duka-1931e.firebaseapp.com",
            projectId: "smart-duka-1931e",
            storageBucket: "smart-duka-1931e.firebasestorage.app",
            messagingSenderId: "768053863535",
            appId: "1:768053863535:web:6fb7d999e9adf71ba4d99a"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        let currentUser = "";
        let dukaID = "duka_kuu_001"; // Hii baadaye itakuwa dynamic kwa kila mteja
        let tareheLeoString = new Date().toLocaleDateString('en-GB');

        // Tab Switching
        window.switchTab = function(tab) {
            if(tab === 'mauzo') {
                document.getElementById('tabMauzo').style.display = 'block';
                document.getElementById('tabMadeni').style.display = 'none';
                document.getElementById('tabMauzoBtn').classList.add('active-tab');
                document.getElementById('tabMadeniBtn').classList.remove('active-tab');
            } else {
                document.getElementById('tabMauzo').style.display = 'none';
                document.getElementById('tabMadeni').style.display = 'block';
                document.getElementById('tabMauzoBtn').classList.remove('active-tab');
                document.getElementById('tabMadeniBtn').classList.add('active-tab');
            }
        };

        // Login Logic
        window.checkLogin = function() {
            const user = document.getElementById('username').value.toLowerCase();
            const pass = document.getElementById('password').value;
            
            if ((user === 'admin' && pass === 'duka2026') || (user === 'muuzaji' && pass === '1234')) {
                currentUser = user;
                document.getElementById('loginPage').style.display = 'none';
                document.getElementById('mainApp').style.display = 'block';
                document.getElementById('userBadge').innerText = "Mtumiaji: " + user.toUpperCase();
                anzishaMfumo();
            } else {
                document.getElementById('errorMsg').innerText = "Username au Password si sahihi!";
            }
        };

        async function anzishaMfumo() {
            // 1. Hali ya Duka
            onSnapshot(doc(db, "mipangilio", dukaID + "_" + tareheLeoString.replace(/\//g, '-')), (docSnap) => {
                const hali = docSnap.exists() ? docSnap.data().hali : 'Imefungwa';
                setUIHali(hali);
            });

            // 2. Live Mauzo
            const qMauzo = query(collection(db, "mauzo"), where("dukaID", "==", dukaID), where("tarehe", "==", tareheLeoString));
            onSnapshot(qMauzo, (snapshot) => {
                let html = ''; let total = 0;
                snapshot.forEach((doc) => {
                    const m = doc.data();
                    total += m.jumla;
                    html += `<div class="item-row">
                        <span><strong>${m.bidhaa}</strong> (x${m.idadi})<br><small>${m.muda}</small></span>
                        <span style="text-align:right;">${m.jumla.toLocaleString()}<br>
                        ${currentUser === 'admin' ? `<button class="btn-futa" onclick="futaKitu('mauzo','${doc.id}')">Futa</button>` : ''}</span>
                    </div>`;
                });
                document.getElementById('orodhaMauzo').innerHTML = html || 'Hakuna mauzo.';
                document.getElementById('leoTotal').innerText = total.toLocaleString();
            });

            // 3. Live Madeni
            const qMadeni = query(collection(db, "madeni"), where("dukaID", "==", dukaID));
            onSnapshot(qMadeni, (snapshot) => {
                let html = '';
                snapshot.forEach((doc) => {
                    const d = doc.data();
                    const imelipwa = d.hali === 'imelipwa';
                    html += `<div class="item-row" style="${imelipwa ? 'opacity:0.5' : ''}">
                        <span><strong style="${imelipwa ? 'text-decoration:line-through' : ''}">${d.jina}</strong><br><small>Tsh ${d.kiasi.toLocaleString()}</small></span>
                        <span>
                            ${!imelipwa ? `<button onclick="lipaDeni('${doc.id}')" style="background:green; color:white; padding:5px;">‚úì</button>` : '‚úÖ'}
                            ${currentUser === 'admin' ? `<button class="btn-futa" onclick="futaKitu('madeni','${doc.id}')">X</button>` : ''}
                        </span>
                    </div>`;
                });
                document.getElementById('orodhaMadeni').innerHTML = html || 'Safi! Hakuna madeni.';
            });
        }

        function setUIHali(hali) {
            const wazi = hali === 'Wazi';
            document.getElementById('statusText').innerText = wazi ? "BIASHARA IKO WAZI" : "BIASHARA IMEFUNGWA";
            document.getElementById('statusBox').style.background = wazi ? "#27ae60" : "#e74c3c";
            document.getElementById('sectionMauzoInput').style.display = wazi ? "block" : "none";
            document.getElementById('cardFungua').style.display = wazi ? "none" : "block";
            document.getElementById('btnFungaDuka').style.display = wazi ? "block" : "none";
        }

        window.badiliHaliDuka = async function(mpya) {
            await setDoc(doc(db, "mipangilio", dukaID + "_" + tareheLeoString.replace(/\//g, '-')), {
                hali: mpya, dukaID: dukaID, mtumiaji: currentUser
            });
        };

        window.ongezaMauzo = async function() {
            const b = document.getElementById('bidhaa').value;
            const p = document.getElementById('bei').value;
            const i = document.getElementById('idadi').value;
            if(b && p && i) {
                await addDoc(collection(db, "mauzo"), {
                    bidhaa: b, bei: parseInt(p), idadi: parseInt(i), jumla: p*i,
                    muda: new Date().toLocaleTimeString('sw-TZ'), tarehe: tareheLeoString,
                    dukaID: dukaID, muuzaji: currentUser, timestamp: Date.now()
                });
                document.getElementById('bidhaa').value = ''; document.getElementById('bei').value = '';
            }
        };

        window.sajiliDeni = async function() {
            const j = document.getElementById('mdeni_jina').value;
            const k = document.getElementById('mdeni_kiasi').value;
            if(j && k) {
                await addDoc(collection(db, "madeni"), {
                    jina: j, kiasi: parseInt(k), hali: "haijalipwa", dukaID: dukaID, tarehe: tareheLeoString
                });
                document.getElementById('mdeni_jina').value = ''; document.getElementById('mdeni_kiasi').value = '';
            }
        };

        window.lipaDeni = async function(id) {
            await updateDoc(doc(db, "madeni", id), { hali: "imelipwa" });
        };

        window.futaKitu = async function(col, id) {
            if(confirm("Je, una uhakika wa kufuta?")) {
                await deleteDoc(doc(db, col, id));
            }
        };

        document.getElementById('tareheLeo').innerText = new Date().toLocaleDateString('sw-TZ', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
    </script>
</body>
</html>
