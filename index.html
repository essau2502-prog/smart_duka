<!DOCTYPE html>
<html lang="sw">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Duka Pro v9.6</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f0f2f5; margin: 0; padding-bottom: 60px; }
        .header { background: #2c3e50; color: white; padding: 15px; text-align: center; position: sticky; top: 0; z-index: 100; }
        .main-card { background: white; margin: 10px; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .total-box { background: #27ae60; color: white; padding: 20px; border-radius: 8px; margin: 10px; text-align: center; }
        input, select { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box; font-size: 1rem; }
        button { cursor: pointer; border: none; border-radius: 5px; font-weight: bold; padding: 12px; margin-top: 5px; width: 100%; transition: 0.3s; }
        .btn-primary { background: #2c3e50; color: white; }
        .btn-uza { background: #27ae60; color: white; }
        .btn-kopa { background: #e67e22; color: white; }
        .btn-futa { background: #e74c3c; color: white; padding: 5px 10px; width: auto; font-size: 0.8rem; }
        .item-row { display: flex; justify-content: space-between; align-items: center; padding: 12px; border-bottom: 1px solid #eee; }
        .tab-bar { display: flex; overflow-x: auto; padding: 10px; gap: 5px; background: #fff; border-bottom: 1px solid #ddd; }
        .tab-btn { padding: 10px 15px; background: #bdc3c7; border-radius: 5px; white-space: nowrap; flex-shrink: 0; font-size: 0.8rem; }
        .active-tab { background: #2c3e50; color: white; }
        .hidden { display: none !important; }
        .auth-page { position: fixed; width: 100%; height: 100%; background: white; z-index: 2000; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 20px; }
        .profit-text { color: #27ae60; font-size: 0.8rem; font-weight: bold; }
    </style>
</head>
<body>

    <div id="authPage" class="auth-page">
        <h2>SMART DUKA PRO üè™</h2>
        <div id="loginForm">
            <input type="text" id="loginDukaID" placeholder="ID ya Duka">
            <input type="text" id="loginUser" placeholder="Jina (admin/staff)">
            <input type="password" id="loginPass" placeholder="Siri">
            <button onclick="handleLogin()" class="btn-primary">INGIA</button>
            <p onclick="toggleAuth()" style="color: #3498db; cursor: pointer; margin-top: 15px;">Sajili Duka Jipya</p>
        </div>
        <div id="registerForm" class="hidden">
            <input type="text" id="regDukaName" placeholder="Jina la Duka">
            <input type="text" id="regDukaID" placeholder="Tengeneza ID ya Duka">
            <input type="password" id="regPass" placeholder="Siri ya Admin">
            <button onclick="handleRegister()" class="btn-primary" style="background: #27ae60;">SAJILI</button>
            <p onclick="toggleAuth()" style="color: #3498db; cursor: pointer; margin-top: 15px;">Rudi Login</p>
        </div>
    </div>

    <div id="mainApp" class="hidden">
        <div class="header">
            <h2 id="dispDuka">DUKA</h2>
            <div id="stDisplay" style="padding:2px 10px; border-radius:10px; font-size:0.8rem; display:inline-block;">...</div><br>
            <span id="dispUser" style="font-size:0.7rem; background:#f1c40f; color:#000; padding:2px 8px; border-radius:5px;"></span>
        </div>

        <div id="adminPanel" class="main-card hidden" style="text-align:center;">
            <button onclick="setHali('Wazi')" style="background:#2ecc71; color:white; width:45%;">FUNGUA</button>
            <button onclick="setHali('Limefungwa')" style="background:#e74c3c; color:white; width:45%;">FUNGA</button>
        </div>

        <div class="total-box">
            <div>Mauzo ya Leo</div>
            <div style="font-size: 1.8rem; font-weight: bold;">Tsh <span id="valTotal">0</span></div>
            <div id="valProfit" style="font-size: 0.9rem; opacity: 0.9;">Faida Leo: Tsh 0</div>
        </div>

        <div class="tab-bar">
            <button id="tabMauzoBtn" class="tab-btn active-tab" onclick="switchTab('mauzo')">Mauzo</button>
            <button id="tabStockBtn" class="tab-btn" onclick="switchTab('stock')">Stok</button>
            <button id="tabMadeniBtn" class="tab-btn" onclick="switchTab('madeni')">Madeni</button>
            <button id="tabReportsBtn" class="tab-btn" onclick="switchTab('reports')">Ripoti</button>
            <button id="tabStaffBtn" class="tab-btn" onclick="switchTab('staff')">Staff</button>
            <button id="tabSupportBtn" class="tab-btn" onclick="switchTab('support')">Msaada</button>
        </div>

        <div id="tabMauzo" class="main-card">
            <div id="lockMsg" class="hidden" style="color:red; text-align:center;"><h3>DUKA LIMEFUNGWA üîí</h3></div>
            <div id="formMauzo">
                <input list="listB" id="uJina" placeholder="Tafuta bidhaa..." onchange="updatePrice()">
                <datalist id="listB"></datalist>
                <input type="number" id="uBei" placeholder="Bei">
                <input type="number" id="uQty" value="1">
                <button onclick="doUza()" class="btn-uza">FANYA MAUZO</button>
            </div>
            <hr>
            <div id="listMauzo"></div>
        </div>

        <div id="tabStock" class="hidden main-card">
            <div id="admStok" class="hidden">
                <h4>Weka Mzigo</h4>
                <input type="text" id="sJina" placeholder="Bidhaa">
                <input type="number" id="sBkununua" placeholder="Bei Kununua">
                <input type="number" id="sBkuuza" placeholder="Bei Kuuza">
                <input type="number" id="sQty" placeholder="Idadi">
                <button onclick="doStok()" class="btn-primary">HIFADHI STOK</button>
                <hr>
            </div>
            <div id="listStok"></div>
        </div>

        <div id="tabReports" class="main-card hidden">
            <h4>Ripoti za Mauzo</h4>
            <input type="date" id="repDate" onchange="fetchReports()">
            <div id="repSummary" style="margin-top:10px;">
                <div style="background:#f9f9f9; padding:10px; border-radius:5px;">Mauzo: <b id="repT">0</b></div>
                <div style="background:#f9f9f9; padding:10px; border-radius:5px; margin-top:5px;" id="repPBox">Faida: <b id="repP">0</b></div>
            </div>
            <hr>
            <div id="listReports"></div>
        </div>

        <div id="tabMadeni" class="hidden main-card">
            <h4>Madeni</h4>
            <input type="text" id="dJina" placeholder="Mdeni">
            <input type="text" id="dKitu" placeholder="Bidhaa">
            <input type="number" id="dKiasi" placeholder="Kiasi">
            <button onclick="doKopa()" class="btn-kopa">SAIDIA DENI</button>
            <hr>
            <div id="listMadeni"></div>
        </div>

        <div id="tabStaff" class="hidden main-card">
            <div id="admStaff" class="hidden">
                <input type="text" id="stfJina" placeholder="Jina Staff">
                <input type="password" id="stfPass" placeholder="Siri">
                <button onclick="doStaff()" class="btn-primary">ONGEZA</button><hr>
            </div>
            <div id="listStaff"></div>
        </div>

        <div id="tabSupport" class="hidden main-card">
            <div style="text-align:center; padding:15px;">
                <strong>ESSAU BRAND OFFICIAL</strong><br>
                <a href="https://wa.me/255758244950" style="display:block; background:#25D366; color:white; padding:12px; text-decoration:none; border-radius:5px; margin-top:10px;">WHATSAPP</a>
            </div>
            <button onclick="location.reload()" style="margin-top:20px; background:#e74c3c; color:white;">LOG OUT</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, where, doc, getDoc, setDoc, updateDoc, deleteDoc, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDXG65JsQ2pB96O33T5itgWUNJPH8IzFuk",
            authDomain: "smart-duka-1931e.firebaseapp.com",
            projectId: "smart-duka-1931e",
            storageBucket: "smart-duka-1931e.firebasestorage.app",
            messagingSenderId: "768053863535",
            appId: "1:768053863535:web:6fb7d999e9adf71ba4d99a"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        let curID = null, isAdmin = false, curUser = "", curStock = {};
        let leo = new Date().toLocaleDateString('en-GB');

        window.toggleAuth = () => { document.getElementById('loginForm').classList.toggle('hidden'); document.getElementById('registerForm').classList.toggle('hidden'); };

        window.handleLogin = async () => {
            const dId = document.getElementById('loginDukaID').value.toLowerCase().trim();
            const u = document.getElementById('loginUser').value.toLowerCase().trim();
            const p = document.getElementById('loginPass').value;
            const snap = await getDoc(doc(db, "maduka", dId));
            if(!snap.exists()) { alert("ID Haipo!"); return; }
            if(u === 'admin' && p === snap.data().adminPass) {
                isAdmin = true; curUser = "Admin";
                document.getElementById('adminPanel').classList.remove('hidden');
                document.getElementById('admStok').classList.remove('hidden');
                document.getElementById('admStaff').classList.remove('hidden');
                loginOk(dId, snap.data().name);
            } else {
                const sSnap = await getDoc(doc(db, "maduka", dId, "staff", u));
                if(sSnap.exists() && sSnap.data().siri === p) { isAdmin = false; curUser = u; loginOk(dId, snap.data().name); }
                else { alert("Login imefeli!"); }
            }
        };

        function loginOk(id, name) {
            curID = id;
            document.getElementById('authPage').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            document.getElementById('dispDuka').innerText = name;
            document.getElementById('dispUser').innerText = curUser;
            runLogic();
        }

        function runLogic() {
            onSnapshot(doc(db, "maduka", curID), (d) => {
                const st = document.getElementById('stDisplay');
                st.innerText = d.data().hali; st.style.background = d.data().hali === 'Wazi' ? '#2ecc71' : '#e74c3c';
            });
            onSnapshot(collection(db, "maduka", curID, "stok"), (snap) => {
                let h = "", opts = ""; snap.forEach(d => {
                    const data = d.data(); curStock[d.id] = data;
                    h += `<div class="item-row"><span><b>${data.bidhaa}</b> (x${data.qty})</span><span>${data.beiS}</span></div>`;
                    opts += `<option value="${data.bidhaa}">`;
                });
                document.getElementById('listStok').innerHTML = h; document.getElementById('listB').innerHTML = opts;
            });
            onSnapshot(query(collection(db, "mauzo"), where("dukaID", "==", curID), where("tarehe", "==", leo)), (snap) => {
                let t = 0, p = 0, h = "";
                snap.forEach(d => { t += d.data().jumla; p += d.data().profit; h += `<div class="item-row"><span>${d.data().bidhaa}</span><b>${d.data().jumla.toLocaleString()}</b></div>`; });
                document.getElementById('valTotal').innerText = t.toLocaleString();
                if(isAdmin) document.getElementById('valProfit').innerText = "Faida Leo: Tsh " + p.toLocaleString();
                document.getElementById('listMauzo').innerHTML = h;
            });
            onSnapshot(collection(db, "maduka", curID, "madeni"), (snap) => {
                let h = ""; snap.forEach(d => { h += `<div class="item-row"><span><b>${d.data().jina}</b><br>${d.data().kitu}</span><div><b>${d.data().kiasi.toLocaleString()}</b> <button onclick="delDeni('${d.id}')" class="btn-futa">LIPA</button></div></div>`; });
                document.getElementById('listMadeni').innerHTML = h;
            });
            onSnapshot(collection(db, "maduka", curID, "staff"), (snap) => {
                let h = ""; snap.forEach(d => { h += `<div class="item-row"><span>${d.id}</span><button onclick="delStaff('${d.id}')" class="btn-futa">Futa</button></div>`; });
                document.getElementById('listStaff').innerHTML = h;
            });
        }

        window.doUza = async () => {
            const j = document.getElementById('uJina').value, b = Number(document.getElementById('uBei').value), q = Number(document.getElementById('uQty').value);
            if(!j || b <= 0) return;
            let prof = 0, bID = null;
            for(let id in curStock) { if(curStock[id].bidhaa.toLowerCase() === j.toLowerCase()) { prof = (b - curStock[id].beiB) * q; bID = id; break; } }
            await addDoc(collection(db, "mauzo"), { bidhaa: j, qty: q, jumla: b*q, profit: prof, dukaID: curID, tarehe: leo });
            if(bID) await updateDoc(doc(db, "maduka", curID, "stok", bID), { qty: curStock[bID].qty - q });
            alert("Umeuza!");
        };
        window.doStok = async () => {
            const j = document.getElementById('sJina').value, bB = Number(document.getElementById('sBkununua').value), bS = Number(document.getElementById('sBkuuza').value), q = Number(document.getElementById('sQty').value);
            if(j) { const id = j.toLowerCase().replace(/\s/g, '_'); await setDoc(doc(db, \"maduka\", curID, \"stok\", id), { bidhaa: j, beiB: bB, beiS: bS, qty: q }); alert(\"Stok Imesave!\"); }
        };
        window.fetchReports = async () => {
            const rd = document.getElementById('repDate').value; if(!rd) return;
            const p = rd.split('-'); const td = `${p[2]}/${p[1]}/${p[0]}`;
            const snap = await getDocs(query(collection(db, "mauzo"), where("dukaID", "==", curID), where("tarehe", "==", td)));
            let h = "", t = 0, pVal = 0; snap.forEach(d => { const da = d.data(); t += da.jumla; pVal += da.profit; h += `<div class="item-row"><span>${da.bidhaa}</span><b>${da.jumla.toLocaleString()}</b></div>`; });
            document.getElementById('repT').innerText = "Tsh " + t.toLocaleString();
            if(isAdmin) document.getElementById('repP').innerText = "Tsh " + pVal.toLocaleString();
            document.getElementById('listReports').innerHTML = h || "Hamna kitu";
        };
        window.setHali = async (h) => { await updateDoc(doc(db, "maduka", curID), { hali: h }); };
        window.doKopa = async () => { await addDoc(collection(db, "maduka", curID, "madeni"), { jina: document.getElementById('dJina').value, kitu: document.getElementById('dKitu').value, kiasi: Number(document.getElementById('dKiasi').value) }); alert("Save!"); };
        window.doStaff = async () => { await setDoc(doc(db, "maduka", curID, "staff", document.getElementById('stfJina').value.toLowerCase().trim()), { siri: document.getElementById('stfPass').value }); alert("Staff OK!"); };
        window.delDeni = async (id) => { if(confirm("Lipa?")) await deleteDoc(doc(db, "maduka", curID, "madeni", id)); };
        window.delStaff = async (id) => { if(confirm("Futa?")) await deleteDoc(doc(db, "maduka", curID, "staff", id)); };
        window.updatePrice = () => { const j = document.getElementById('uJina').value; for(let id in curStock) { if(curStock[id].bidhaa === j) { document.getElementById('uBei').value = curStock[id].beiS; break; } } };
        window.switchTab = (t) => { ['mauzo','stock','madeni','reports','staff','support'].forEach(id => { document.getElementById('tab' + id.charAt(0).toUpperCase() + id.slice(1)).classList.toggle('hidden', t !== id); document.getElementById('tab' + id.charAt(0).toUpperCase() + id.slice(1) + 'Btn').classList.toggle('active-tab', t === id); }); };
        window.handleRegister = async () => {
            const id = document.getElementById('regDukaID').value.toLowerCase().trim();
            if(id) { await setDoc(doc(db, "maduka", id), { name: document.getElementById('regDukaName').value, adminPass: document.getElementById('regPass').value, hali: 'Wazi' }); alert("Duka Sawa!"); toggleAuth(); }
        };
    </script>
</body>
</html>
